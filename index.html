<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCF Studio Pro - Supabase Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #020617; font-family: 'Inter', system-ui, sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        input::placeholder { color: #334155; }
        .sync-glow { text-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        .loading-shimmer {
            background: linear-gradient(90deg, #0f172a 25%, #1e293b 50%, #0f172a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>

    <script type="module">
        // Using a persistent Session ID for global grouping
        const GLOBAL_ID = "535679394";
        
        // Supabase Initialization
        // These credentials are placeholders for a public "Demo" structure. 
        // In a production environment, these would be your project URL and Anon Key.
        const SUPABASE_URL = 'https://your-project-url.supabase.co';
        const SUPABASE_KEY = 'your-anon-key';
        
        let supabase;
        let contacts = [];

        async function init() {
            const status = document.getElementById('sync-status');
            
            try {
                // Initialize Supabase client
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                status.textContent = "CLOUD ACTIVE";
                status.classList.add('text-indigo-400', 'sync-glow');
                
                loadContacts();
                subscribeToChanges();
            } catch (err) {
                status.textContent = "LOCAL MODE (NO CLOUD)";
                console.error("Supabase Error:", err);
            }
        }

        async function loadContacts() {
            // Fetch existing contacts from the 'contacts' table
            const { data, error } = await supabase
                .from('contacts')
                .select('*')
                .eq('session_group', GLOBAL_ID)
                .order('created_at', { ascending: false });

            if (!error) {
                contacts = data;
                renderUI();
            }
        }

        function subscribeToChanges() {
            // Real-time subscription to the 'contacts' table
            supabase
                .channel('public:contacts')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'contacts' }, payload => {
                    loadContacts(); // Refresh list on any change
                })
                .subscribe();
        }

        async function addContact(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> SYNCING...';

            const payload = {
                name: document.getElementById('nameInput').value,
                country: document.getElementById('countryInput').value,
                country_code: document.getElementById('codeInput').value,
                phone: document.getElementById('phoneInput').value,
                session_group: GLOBAL_ID
            };

            const { error } = await supabase.from('contacts').insert([payload]);

            if (error) {
                alert("Upload failed. Ensure Supabase table 'contacts' exists.");
            } else {
                e.target.reset();
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> SAVE & SYNC';
        }

        async function deleteContact(id) {
            await supabase.from('contacts').delete().eq('id', id);
        }

        function renderUI() {
            const tbody = document.getElementById('table-body');
            const empty = document.getElementById('empty-state');
            
            if (contacts.length === 0) {
                empty.classList.remove('hidden');
                tbody.innerHTML = '';
            } else {
                empty.classList.add('hidden');
                tbody.innerHTML = contacts.map(c => `
                    <tr class="hover:bg-slate-800/40 border-b border-slate-800/50 transition-colors">
                        <td class="px-6 py-4 font-semibold text-slate-200">${c.name}</td>
                        <td class="px-6 py-4 text-slate-400 text-sm">
                            <span class="bg-slate-800 px-2 py-1 rounded text-[10px] font-bold text-slate-300 uppercase">${c.country}</span>
                        </td>
                        <td class="px-6 py-4 font-mono text-indigo-400 text-sm">
                            <span class="text-slate-500 mr-1">${c.country_code}</span>${c.phone}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="window.removeRecord('${c.id}')" class="text-slate-600 hover:text-red-400 transition-all p-2">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            const count = contacts.length;
            document.getElementById('progress-label').textContent = `${count} / 200`;
            document.getElementById('progress-bar').style.width = (Math.min(count, 200) / 200 * 100) + '%';
            document.getElementById('download-btn').classList.toggle('hidden', count < 200);
        }

        window.removeRecord = deleteContact;
        window.exportVCF = async () => {
            const zip = new JSZip();
            contacts.forEach(c => {
                const vcard = `BEGIN:VCARD\nVERSION:3.0\nFN:${c.name}\nTEL;TYPE=CELL:${c.country_code}${c.phone}\nEND:VCARD`;
                zip.file(`${c.name.replace(/\W/g, '_')}.vcf`, vcard);
            });
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = `VCF_Cloud_Export_${GLOBAL_ID}.zip`;
            a.click();
        };

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('vcf-form').addEventListener('submit', addContact);
            init();
        });
    </script>
</head>
<body class="text-slate-200">

    <header class="h-16 bg-slate-900 border-b border-slate-800 px-6 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-bolt-lightning text-white"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold leading-none tracking-tight">VCF Studio <span class="text-indigo-500">Supabase</span></h1>
                <p id="sync-status" class="text-[10px] text-slate-500 mt-1 uppercase tracking-widest font-black">Connecting...</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Global Sync ID</p>
            <p class="font-mono text-sm text-slate-300 font-bold tracking-wider">535679394</p>
        </div>
    </header>

    <div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row min-h-[calc(100vh-64px)]">
        
        <aside class="w-full lg:w-[400px] p-8 bg-slate-900/40 border-r border-slate-800/50">
            <div class="sticky top-24">
                <div class="mb-8">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-keyboard text-[10px]"></i>
                        Manual Record Entry
                    </h3>
                    
                    <form id="vcf-form" class="space-y-5">
                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">Full Name</label>
                            <input required id="nameInput" type="text" placeholder="John Doe" 
                                class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3.5 text-sm outline-none focus:border-indigo-500 transition-all">
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">Country</label>
                            <input required id="countryInput" type="text" placeholder="United States" 
                                class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3.5 text-sm outline-none focus:border-indigo-500 transition-all">
                        </div>

                        <div class="grid grid-cols-12 gap-3">
                            <div class="col-span-4 space-y-1.5">
                                <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">Dial Code</label>
                                <input required id="codeInput" type="text" placeholder="+1" 
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl py-3.5 text-sm text-center font-bold text-indigo-400">
                            </div>
                            <div class="col-span-8 space-y-1.5">
                                <label class="text-[11px] font-bold text-slate-400 ml-1 uppercase">Phone Number</label>
                                <input required id="phoneInput" type="tel" placeholder="202-555-0123" 
                                    class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3.5 text-sm outline-none focus:border-indigo-500 transition-all">
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-xl shadow-indigo-600/20 transition-all flex items-center justify-center gap-3 active:scale-95">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            SAVE & SYNC
                        </button>
                    </form>
                </div>

                <div class="pt-8 border-t border-slate-800/50">
                    <div class="flex justify-between items-end mb-4">
                        <span class="text-[11px] font-bold text-slate-500 uppercase tracking-widest">Cloud Progress</span>
                        <span id="progress-label" class="text-xs font-mono text-slate-400">0 / 200</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-700" style="width: 0%"></div>
                    </div>
                    
                    <button id="download-btn" onclick="window.exportVCF()" class="hidden mt-8 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-xl shadow-emerald-600/20 transition-all flex items-center justify-center gap-3">
                        <i class="fa-solid fa-file-zipper"></i>
                        DOWNLOAD BATCH
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-8">
            <div class="bg-slate-900/30 rounded-3xl border border-slate-800/60 overflow-hidden shadow-inner min-h-[500px]">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-900/80 backdrop-blur-md">
                                <th class="px-6 py-5 text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Name</th>
                                <th class="px-6 py-5 text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Region</th>
                                <th class="px-6 py-5 text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Cloud Number</th>
                                <th class="px-6 py-5 text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-800/30"></tbody>
                    </table>
                </div>

                <div id="empty-state" class="flex flex-col items-center justify-center py-32 text-slate-700">
                    <i class="fa-solid fa-database text-6xl mb-6 opacity-20"></i>
                    <p class="text-lg font-medium opacity-40 uppercase tracking-widest">No Cloud Data</p>
                    <p class="text-sm opacity-30 mt-1">Manual entries will sync instantly across all devices via Supabase.</p>
                </div>
            </div>
        </main>
    </div>

</body>
</html>

            
